<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8äººå®æ—¶ç»„é˜ŸæŠ½ç­¾</title>
    <style>
        :root { --m-color: #3b82f6; --f-color: #ec4899; }
        body { font-family: system-ui; background: #f0f2f5; display: flex; justify-content: center; padding-top: 50px; margin: 0; }
        .card { background: white; width: 90%; max-width: 380px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        #num-box { font-size: 4rem; font-weight: bold; margin: 20px 0; height: 120px; line-height: 120px; border: 3px dashed #ddd; border-radius: 15px; color: #333; }
        .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        button { padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-m { background: var(--m-color); color: white; }
        .btn-f { background: var(--f-color); color: white; }
        .btn-reset { background: #64748b; color: white; width: 100%; margin-top: 20px; }
        button:disabled { background: #cbd5e1; cursor: not-allowed; }
        .status { margin-top: 15px; font-size: 0.85rem; color: #666; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="margin-top:0">ğŸ‘« å®æ—¶ç»„é˜ŸæŠ½ç­¾</h2>
    <div id="num-box">?</div>
    
    <div class="btns">
        <button id="m-btn" class="btn-m" onclick="draw('male')">æˆ‘æ˜¯ç”·ç”Ÿ</button>
        <button id="f-btn" class="btn-f" onclick="draw('female')">æˆ‘æ˜¯å¥³ç”Ÿ</button>
    </div>

    <button class="btn-reset" onclick="resetGame()">ğŸ”„ å…¨å‘˜å¼ºåˆ¶åˆ·æ–°é‡ç½®</button>
    
    <div class="status">
        <span id="stat-text">æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...</span><br>
        <small id="sync-time"></small>
    </div>
</div>

<script>
    // ä½¿ç”¨ JSONBin çš„å…¬å…±ç®±å­ï¼ˆæ­¤å¤„ä¸ºä¸€ä¸ªæ¼”ç¤ºç”¨çš„å…¬å…± IDï¼Œå»ºè®®å¤§è§„æ¨¡ä½¿ç”¨æ—¶å» jsonbin.io ç”³è¯·è‡ªå·±çš„ï¼‰
    const BIN_ID = '65979c5c1f567761d258679d'; // è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤º ID
    const API_KEY = '$2a$10$7XyH1XJkU/zW.v.P/6mPue.7M6qXw5v8G6XoYvV'; // æ¼”ç¤º Key
    const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    let currentData = { male: [1,2,3,4], female: [1,2,3,4], version: 0 };
    let myResult = null;
    let lastKnownVersion = 0;

    // 1. ä»äº‘ç«¯è·å–æ•°æ®
    async function fetchData() {
        try {
            const res = await fetch(URL + '/latest', {
                headers: { 'X-Master-Key': API_KEY }
            });
            const json = await res.json();
            currentData = json.record;
            
            // å¦‚æœäº‘ç«¯ç‰ˆæœ¬å˜äº†ï¼ˆæœ‰äººç‚¹äº†åˆ·æ–°ï¼‰ï¼Œæœ¬åœ°ä¹Ÿåˆ·æ–°
            if (lastKnownVersion !== 0 && currentData.version !== lastKnownVersion) {
                location.reload();
            }
            lastKnownVersion = currentData.version;
            updateUI();
        } catch (e) { console.error("åŒæ­¥å¤±è´¥"); }
    }

    // 2. æŠ½ç­¾é€»è¾‘
    async function draw(gender) {
        if (myResult) return;
        
        document.getElementById('stat-text').innerText = "æ­£åœ¨é”å®šåé¢...";
        await fetchData(); // æŠ½ä¹‹å‰å…ˆæ‹¿æœ€æ–°çš„ï¼Œé˜²æ­¢æ’è½¦

        const pool = currentData[gender];
        if (pool.length === 0) {
            alert("è¯¥æ€§åˆ«å·²æŠ½å®Œï¼");
            return;
        }

        const index = Math.floor(Math.random() * pool.length);
        myResult = pool.splice(index, 1)[0];

        // æ›´æ–°åˆ°äº‘ç«¯
        await updateCloud();

        document.getElementById('num-box').innerText = myResult;
        document.getElementById('num-box').style.color = (gender === 'male' ? 'var(--m-color)' : 'var(--f-color)');
        document.getElementById('m-btn').disabled = true;
        document.getElementById('f-btn').disabled = true;
    }

    // 3. é‡ç½®é€»è¾‘
    async function resetGame() {
        if(!confirm("ç¡®å®šè¦è®©æ‰€æœ‰äººé‡é€‰å—ï¼Ÿ")) return;
        currentData = { male: [1,2,3,4], female: [1,2,3,4], version: Date.now() };
        await updateCloud();
        location.reload();
    }

    async function updateCloud() {
        await fetch(URL, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': API_KEY
            },
            body: JSON.stringify(currentData)
        });
    }

    function updateUI() {
        document.getElementById('stat-text').innerText = 
            `å‰©ä½™ï¼šç”· ${currentData.male.length}ä½ / å¥³ ${currentData.female.length}ä½`;
        document.getElementById('sync-time').innerText = "åŒæ­¥æ—¶é—´: " + new Date().toLocaleTimeString();
    }

    // æ¯ 3 ç§’è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡äº‘ç«¯ï¼Œå®ç°â€œå…¨å‘˜è‡ªåŠ¨åˆ·æ–°â€
    setInterval(fetchData, 3000);
    fetchData();
</script>

</body>
</html>