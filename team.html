<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8äººå®æ—¶ç»„é˜ŸæŠ½ç­¾</title>
    <style>
        :root { --m-color: #3b82f6; --f-color: #ec4899; }
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 40px 20px; margin: 0; }
        .card { background: white; width: 100%; max-width: 380px; padding: 30px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; }
        #num-box { font-size: 5rem; font-weight: 800; margin: 25px 0; height: 140px; line-height: 140px; border: 4px dashed #eee; border-radius: 20px; color: #1e293b; background: #fafafa; transition: all 0.3s; }
        .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        button { padding: 18px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        .btn-m { background: var(--m-color); color: white; }
        .btn-f { background: var(--f-color); color: white; }
        .btn-reset { background: #64748b; color: white; width: 100%; margin-top: 25px; opacity: 0.8; }
        button:disabled { background: #cbd5e1; cursor: not-allowed; transform: scale(1) !important; }
        button:active { transform: scale(0.95); }
        .status { margin-top: 20px; font-size: 0.85rem; color: #94a3b8; line-height: 1.6; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="margin: 0; color: #1e293b;">ğŸ‘« å®æ—¶ç»„é˜ŸæŠ½ç­¾</h2>
    <div id="num-box">?</div>
    
    <div class="btns">
        <button id="m-btn" class="btn-m" onclick="draw('male')">æˆ‘æ˜¯ç”·ç”Ÿ</button>
        <button id="f-btn" class="btn-f" onclick="draw('female')">æˆ‘æ˜¯å¥³ç”Ÿ</button>
    </div>

    <button class="btn-reset" onclick="resetGame()">ğŸ”„ å…¨å‘˜å¼ºåˆ¶åˆ·æ–°é‡ç½®</button>
    
    <div class="status">
        <div id="stat-text">æ­£åœ¨è¿æ¥äº‘ç«¯...</div>
        <div id="sync-time" style="font-size: 0.7rem;"></div>
    </div>
</div>

<script>
    // ä½¿ç”¨å…¬å…±æ¼”ç¤ºæµ‹è¯• ID (å»ºè®®æ­£å¼ä½¿ç”¨æ—¶æ›´æ¢ä¸ºä½ è‡ªå·±çš„ JSONBin ID)
    const BIN_ID = '65979c5c1f567761d258679d'; 
    const API_KEY = '$2a$10$7XyH1XJkU/zW.v.P/6mPue.7M6qXw5v8G6XoYvV'; 
    const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    let currentData = { male: [1,2,3,4], female: [1,2,3,4], version: 0 };
    let myResult = localStorage.getItem('my_draw_res');
    let lastVersion = 0;

    // é¡µé¢åŠ è½½æ£€æŸ¥
    if(myResult) {
        document.getElementById('num-box').innerText = myResult;
        document.getElementById('m-btn').disabled = true;
        document.getElementById('f-btn').disabled = true;
    }

    async function fetchData() {
        try {
            const res = await fetch(URL + '/latest', { headers: { 'X-Master-Key': API_KEY } });
            const json = await res.json();
            currentData = json.record;
            
            // å®æ—¶åŒæ­¥åˆ·æ–°é€»è¾‘ï¼šå¦‚æœäº‘ç«¯ç‰ˆæœ¬å˜äº†ï¼Œå…¨å‘˜åˆ·æ–°
            if (lastVersion !== 0 && currentData.version !== lastVersion) {
                localStorage.removeItem('my_draw_res');
                location.reload();
            }
            lastVersion = currentData.version;
            updateUI();
        } catch (e) { console.log("åŒæ­¥ä¸­..."); }
    }

    async function draw(gender) {
        if (myResult) return;
        document.getElementById('stat-text').innerText = "é”å®šåé¢ä¸­...";
        
        await fetchData();
        const pool = currentData[gender];
        if (pool.length === 0) { alert("è¯¥æ€§åˆ«å·²æŠ½å®Œï¼"); return; }

        const index = Math.floor(Math.random() * pool.length);
        myResult = pool.splice(index, 1)[0];
        
        await updateCloud();
        localStorage.setItem('my_draw_res', myResult);
        location.reload(); // æŠ½å®Œåˆ·æ–°ä¸€ä¸‹ä»¥é”å®šçŠ¶æ€
    }

    async function resetGame() {
        if(!confirm("ç¡®å®šè¦è®©æ‰€æœ‰äººé‡é€‰å—ï¼Ÿ")) return;
        currentData = { male: [1,2,3,4], female: [1,2,3,4], version: Date.now() };
        await updateCloud();
        localStorage.removeItem('my_draw_res');
        location.reload();
    }

    async function updateCloud() {
        await fetch(URL, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
            body: JSON.stringify(currentData)
        });
    }

    function updateUI() {
        document.getElementById('stat-text').innerHTML = `å‰©ä½™åé¢ï¼š<br>ç”· <b>${currentData.male.length}</b> ä½ | å¥³ <b>${currentData.female.length}</b> ä½`;
        document.getElementById('sync-time').innerText = "æœ€ååŒæ­¥: " + new Date().toLocaleTimeString();
    }

    setInterval(fetchData, 3000);
    fetchData();
</script>

</body>
</html>
